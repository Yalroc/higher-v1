<div id="job_offers_index_wrapper">
  <div class="row">
    <div class="tableau-offer">
      <table class="vw">
        <!-- table headline -->
        <thead class="head-fixed text-center">
          <div class="navbar-higher-brand-recruiter2">
            <%= image_tag "LOreal_black_vector.png" %>
          </div>
          <div class="btn-group navbar-higher-btn-group-recruiter" role="group" aria-label="...">
            <button type="button" class="btn btn-default" data-toggle="modal" data-target="#CreateJobOfferModal"><%= image_tag "noun_job.png", class: "cv-icon" %>+</button>
            <button type="button" class="btn btn-default" data-toggle="modal" data-target="#AddFolderModal"><i class="fa fa-folder folder-icon" aria-hidden="true"></i>+</button>
          </div>
          <tr class="flex height-40px bold table-head">
            <th class="column-0"></th>
            <th class="column-1 text-center"></th>
            <th class="column-2 text-center">Offers</th>
            <th class="column-3 text-center">Candidates</th>
            <th class="column-4 text-center">Contacted</th>
            <td class="column-5 text-center">Average Fit</td>
          </tr>
        </thead>

        <!-- table body -->
        <% if @job_offers.any? || @job_offer_folders.any? %>
          <tbody class="offers-body">

            <!-- first row: HOLDING -->
            <tr class="border bold holding-row">
              <td class="column-0"></td>
              <td class="column-1 text-left folder">
                <%= link_to root_path do %>
                  <span id="organization_overhead_name">Holding</span>
                <% end %>
              </td>
              <td class="column-2"><%= @job_offers.count %></td>
              <td class="column-3"><%= @job_applications.select { |job_application| job_application.submit == true && job_application.rejected == nil }.count %></td>
              <td class="column-4"><%= @job_applications.select { |job_application| job_application.contact == true && job_application.rejected == nil }.count %></td>
              <td class="column-5"><%= rand(75..85).round(1).to_s + "%" %></td>
            </tr> <!-- end of iteration over @job_offer_folders -->

            <!-- Method to calculate folder and job_offer indentation -->
            <% def tree_level(node) %>
              <% no_parent = false %>
              <% level = -1 %>
              <% if node.class == JobOffer %>
                <% level = level + 1 %>
                <% node = node.job_offer_folder %>
              <% end %>
              <% while no_parent == false do %>
                <% node = node.parent %>
                <% no_parent = node.nil? %>
                <% level = level + 1 %>
              <% end %>
              <% return level %>
            <% end %>


            <!-- Methods to count job_offers inside folders -->
            <% def count_offers_inside_folder(folder) %>
              <% sum = 0 %>
              <% if folder.job_offers.any? %>
                <% sum += folder.job_offers.count %>
              <% end %>
              <% return sum %>
            <% end %>

            <% def dive_inside_folder_for_offers(folder, sum) %>
              <% if folder.job_offer_folders.any? %>
                <% folder.job_offer_folders.each do |child_folder| %>
                  <% sum += count_offers_inside_folder(child_folder).to_i %>
                  <% dive_inside_folder_for_offers(child_folder, sum) %>
                <% end %>
              <% end %>
              <% return sum %>
            <% end %>

            <% def count_down_tree_for_offers(folder) %> <!-- condition = submit or contact -->
              <% sum = 0 %>
              <% sum += count_offers_inside_folder(folder).to_i %>
              <% sum = dive_inside_folder_for_offers(folder, sum) %>
              <% return sum %>
            <% end %>


            <!-- Methods to count submitted job_applications -->
            <% def count_applications_inside_folder(folder) %>
              <% sum = 0 %>
              <% if folder.job_offers.any? %>
                <% folder.job_offers.each do |offer| %>
                  <% sum += offer.job_applications.where(submit: true, rejected: nil).count %>
                <% end %>
              <% end %>
              <% return sum %>
            <% end %>

            <% def dive_inside_folder(folder, sum) %>
              <% if folder.job_offer_folders.any? %>
                <% folder.job_offer_folders.each do |child_folder| %>
                  <% sum += count_applications_inside_folder(child_folder).to_i %>
                  <% dive_inside_folder(child_folder, sum) %>
                <% end %>
              <% end %>
              <% return sum %>
            <% end %>

            <% def count_down_tree(folder) %> <!-- condition = submit or contact -->
              <% sum = 0 %>
              <% sum = sum + count_applications_inside_folder(folder).to_i %>
              <% sum = dive_inside_folder(folder, sum) %>
              <% return sum %>
            <% end %>


            <!-- Methods to count contact job_applications -->
            <% def count_contacted_applications_inside_folder(folder) %>
              <% sum = 0 %>
              <% if folder.job_offers.any? %>
                <% folder.job_offers.each do |offer| %>
                  <% sum = sum + offer.job_applications.where(contact: true, rejected: nil).count %>
                <% end %>
              <% end %>
              <% return sum %>
            <% end %>

            <% def dive_inside_folder_for_contacted(folder, sum) %>
              <% if folder.job_offer_folders.any? %>
                <% folder.job_offer_folders.each do |child_folder| %>
                  <% sum = sum + count_contacted_applications_inside_folder(child_folder).to_i %>
                  <% dive_inside_folder_for_contacted(child_folder, sum) %>
                <% end %>
              <% end %>
              <% return sum %>
            <% end %>

            <% def count_down_tree_for_contacted(folder) %> <!-- condition = submit or contact -->
              <% sum = 0 %>
              <% sum += count_contacted_applications_inside_folder(folder).to_i %>
              <% sum = dive_inside_folder_for_contacted(folder, sum) %>
              <% return sum %>
            <% end %>


            <!-- RECURSIVE METHOD (TREE STRUCTURE) -->
            <%  def draw_tree(parent_folder) %>
               <% parent_folder.job_offer_folders.each do |folder| %>
                  <%= folder_html(folder) %>
                  <% if folder.job_offers.any? %>
                    <% folder.job_offers.each do |offer| %>
                      <%= offer_html(offer) %>
                    <% end %>
                  <% end %>
                  <% if folder.job_offer_folders.any? %>
                    <% draw_tree(folder) %>
                  <% end %>
               <% end %>
            <%  end %>

            <%  def folder_html(folder) %>
                  <tr class="border <%= folder.parent ? "" : "parent-folder-row" %> <%= 'tree-folder-level-' + tree_level(folder).to_s %>">
                    <td class="column-0"><i class="fa fa-star-o star-icon" aria-hidden="true"></i><i class="fa fa-star star-icon hidden" aria-hidden="true"></i></td>
                    <td class="column-1 text-left bold <%= 'folder-indentation-' + tree_level(folder).to_s %>">
                      <%= link_to root_path, class: "folder-link" do %>
                        <i class="fa fa-folder-open folder-icon hidden" aria-hidden="true"></i><i class="fa fa-folder folder-icon" aria-hidden="true"></i><%= " " + folder.name %>
                      <% end %>
                      <%= link_to root_path , class: "offer_settings_icon" do %>
                        <i class="fa fa-cog aria-hidden="true"></i>
                      <% end %>
                    </td>
                    <td class="column-2">
                        <%= count_down_tree_for_offers(folder).to_s %>
                    </td>
                    <td class="column-3">
                      <% if folder.job_offer_folders.empty? && folder.job_offers.count == 1 && folder.parent %>
                        <%= "-" %>
                      <% else %>
                        <%= count_down_tree(folder).to_s %>
                      <% end %>
                    </td>
                    <td class="column-4">
                      <% if folder.job_offer_folders.empty? && folder.job_offers.count == 1 && folder.parent %>
                        <%= "-" %>
                      <% else %>
                        <%= count_down_tree_for_contacted(folder).to_s %>
                      <% end %>
                    </td>
                    <td class="column-5">
                      <% if folder.job_offer_folders.empty? && folder.job_offers.count == 1 && folder.parent %>
                        <%= "-" %>
                      <% else %>
                        <%= rand(60..90).round(1).to_s + "%" %></td>
                      <% end %>
                  </tr>
            <%  end %>


            <%  def offer_html(offer) %>
                  <tr class="border">
                    <td class="column-0"><i class="fa fa-star-o star-icon" aria-hidden="true"></i><i class="fa fa-star star-icon hidden" aria-hidden="true"></i></td>
                    <td class="column-1 text-left <%= 'folder-indentation-' + tree_level(offer).to_s %>">
                      <%= link_to job_offer_job_applications_path(offer), class: "offer-link" do %>
                        <%= image_tag "noun_job.png", class: "cv-icon" %>
                        <%= offer.title %>
                      <% end %>
                      <%= link_to job_offer_job_applications_path(offer), class: "offer_settings_icon" do %>
                        <i class="fa fa-cog aria-hidden="true"></i>
                      <% end %>
                    </td>
                    <td class="column-2">
                      <% days_ago = ((Time.now - offer.created_at) / (24 * 60 * 60)).to_i %>
                      <% if I18n.l(offer.created_at, format: "%A") == I18n.l(Date.today, format: "%A")  %>
                        <% days_ago = "Today"%>
                      <% else %>
                        <% if days_ago <= 1 %>
                          <% days_ago = "1 day ago" %>
                        <% else %>
                        <% days_ago = "#{((Time.now - offer.created_at) / (24 * 60 * 60)).to_i} days ago" %>
                        <% end %>
                      <% end %>
                      <% months_array = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"]%>
                      <% creation_date = "(" + (offer.created_at.day > 9 ? "" : "0") + offer.created_at.day.to_s + "-" + months_array[offer.created_at.month - 1] + ")" %>
                      <%= days_ago + " " + creation_date %>
                    </td>
                    <td class="column-3"><%= offer.job_applications.where(submit: true, rejected: nil).count %></td>
                    <td class="column-4"><%= offer.job_applications.where(contact: true, rejected: nil).count %></td>

                    <td class="column-5"><%= rand(50..100).round(1).to_s + "%" %></td>
                  </tr>
            <%  end %>


            <!-- draw tree -->
            <% @parent_folders.each do |folder| %>
              <%= folder_html(folder) %>
              <% if folder.job_offers.any? %>
                <% folder.job_offers.each do |offer| %>
                  <%= offer_html(offer) %>
                <% end %>
              <% end %>
              <% draw_tree(folder) %>
            <% end %>


          </tbody>
        <% else %> <!-- if table is empty don't iterate -->
        <% end %>  <!-- end of if function -->
      </table>
    </div>
  </div>
</div>

<!-- SCRIPTS -->

<!-- Modal: Create Offer -->
<div class="modal fade" id="CreateJobOfferModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Create an offer</h4>
      </div>
      <div class="modal-body">
        <%= simple_form_for([ @job_offer ]) do |form| %>
          <%= form.input :title %>
          <%= form.input :job_offer_folder_id, label: 'In which folder?', hint: 'Select the folder in which you want the job offer to go. Can\'t be blank.', collection: @all_folders, class: 'String' %>
          <%= form.button :submit, value: "CREATE JOB OFFER" %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Create a Folder -->
<div class="modal fade" id="AddFolderModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Add a Folder</h4>
      </div>
      <div class="modal-body">
        <%= simple_form_for([ @job_offer_folder ]) do |form| %>
          <%= form.input :name %>
          <%= form.input :parent_id, label: 'In which folder?', hint: 'If you want your folder to stand alone, leave this field blank.', collection: @all_folders, class: 'String' %>
          <%= form.button :submit, value: 'ADD FOLDER' %>
        <% end %>
      </div>
    </div>
  </div>
</div>


<!-- Modal: Edit a Job Offer -->
<div class="modal fade" id="EditJobOfferModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Create an offer</h4>
      </div>
      <div class="modal-body">
        <%= simple_form_for([ @job_offer ]) do |form| %>
          <%= form.input :title %>
          <%= form.input :description, input_html: { id: 'job_offer_description_field' } %>
          <%= form.input :location %>
          <%= form.input :min_xp %>
          <%= form.input :max_xp %>
          <%= form.input :salary %>
          <%= form.button :submit %>
        <% end %>
      </div>
    </div>
  </div>
</div>
